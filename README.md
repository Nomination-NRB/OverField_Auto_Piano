# 🎹 Python 自动弹琴脚本

## 📖 功能介绍
本脚本由AI辅助编写，适用于 《开放空间》 Windows 平台，可以根据指定的乐谱文件，自动模拟键盘输入，在游戏中实现“自动弹琴”。
- **支持乐器**
  - 键盘

- **支持音域**  
  - 低音 1~7 → `asdfghj`  
  - 中音 1~7 → `qwertyu`  
  - 高音 1~7 → `1234567`  
  - 和弦（C, Dm, Em, F, G, Am, G7） → `zxcvbnm`  

- **可视化功能**  
  提供简单的窗口界面，可以选择乐谱文件并启动演奏。

- **自动演奏**  
  根据乐谱的时间轴，自动模拟键盘按键，实现自动弹奏。

- **延长音支持**  
  通过双时间戳 `[开始][结束]` 实现按下保持到指定释放时间。

- **mid格式转换**  
  根据midi音乐文件自动转换为本程序支持的乐谱格式（会输出延长音）。

- **多人模式（NEW）**  
  针对多人联机中“漏音 / 丢音”问题的降级方案：去除和弦 + 多音时间分散，降低同一瞬间按键密度。

---

## 📂 文件结构
- `play_piano.py` → 单人/原版主程序（完整旋律含和弦）  
- `play_piano_multi.py` → 多人模式（去和弦 + 多音时间分散）  
- `twinkle_sample.lrcp` → 示例乐谱文件（《一闪一闪亮晶晶》）  
- `卡农.mid` → 示例mid文件（《卡农》）  
- `卡农.lrcp` → 示例乐谱文件（《卡农》）  
- `README.md` → 使用说明书  
- `README_Piano_Autoplayer_Tutorial.txt` → 乐谱编写教程  
- `midi2lrcp.py` → mid文件转换工具  
---

## 📝 乐谱文件格式说明
乐谱文件采用类似 LRC 的格式，扩展名建议使用 `.lrcp`。

- **短音行格式：**
  ```
  [时间] 音符(可多个)
  ```
  单时间戳表示点按（按下后立即释放）。

- **延长音行格式：**
  ```
  [开始时间][结束时间] 音符(可多个)
  ```
  第一时间戳表示按下，第二时间戳表示释放。适合需要 sustain 的音或和弦。

- **多个独立重复短音：**
  ```
  [00:01.000][00:01.500] C   # 两次短音 C（结束时间不大于开始时间不被视为延长）
  ```

- **音符映射表：**  
  - 低音：`L1`~`L7`  
  - 中音：`M1`~`M7`  
  - 高音：`H1`~`H7`  
  - 和弦：`C, Dm, Em, F, G, Am, G7`  

### 示例：《一闪一闪亮晶晶》（节选，加入延长演示）
```lrcp
[00:00.000][00:00.600] M1 C
[00:00.600] M1
[00:01.199] M5
[00:01.799] M5
[00:02.399][00:03.000] M6
[00:03.600] M5
```

---

## ▶️ 使用方法（单人 / 原版）
1. 安装依赖
   ```bash
   pip install pyautogui keyboard pretty_midi
   ```
2. 以**管理员权限**运行脚本：
   ```bash
   python play_piano.py
   ```
3. 在窗口中：
   - 载入 `.lrcp` 乐谱  
   - 设置参数（速度 / 倒计时 / 全局延迟）  
   - 点击“开始演奏”
4. 运行期间切回游戏窗口保持焦点即可听到自动演奏。

---

## 🤝 多人模式说明 (play_piano_multi.py)
### 背景问题
多人联机里可能出现：
1. 同时按两键时，其他玩家只能听到一个，甚至副手和弦“挤掉”主旋律；
2. 极短时间内可被正确播放的按键数量受限（估计 ~ 每秒 3~4 个实际生效）。

### 策略
为提升他人端听感，`play_piano_multi.py` 做以下退化预处理（不修改源谱文件）：
- 去除所有和弦（C, Dm, Em, F, G, Am, G7），避免宽音堆叠；
- 若同一时间戳包含多个单音，按顺序给予“时间偏移”分散（提前或延后若干毫秒）；
- 延长音会整体平移（保持时长不变）。

### 多音偏移参数
界面输入框示例：
```
-15,0,15
```
含义：
- 第1个音：提前15ms；第2个：不变；第3个：延后15ms；第4个再次使用第1个偏移，如此循环。

规则：
- 支持逗号 / 空格 / 分号分隔；
- 范围限制：每个值 -50 ~ 50 ms（超出将被裁剪）；
- 留空或非法全部被过滤后，默认为 0；
- 可尝试小尺度组合：`-20,0,20`、`-10,5,15` 等；
- 偏移仅运行期生效，不写回谱文件。

### 何时使用
- 原谱含大量和弦、密集装饰音，联机中他人听不清主旋律；
- 经常出现“打一串但对方几乎没听见”情况。 

### 使用步骤
```bash
python play_piano_multi.py
```
然后：
1. 载入原 `.lrcp` 乐谱；
2. 根据情况调整“多音偏移(ms)”；
3. 点击开始；
4. 若仍感觉漏音，可：
   - 减小速度比例 (<1.0 放慢整体)；
   - 增大多音间隔（更大的正负偏移）；
   - 减少谱中本就极密的修饰音（手动修谱）。

### 效果与取舍
- 优点：主旋律清晰度在他人端提升；丢音概率降低。
- 代价：失去原本和弦丰满度，部分“同时”音会轻微错位。

---

## ⚠️ 注意事项
- 需 **管理员权限** 运行（否则可能无法注入按键）。  
- 游戏可能存在反作弊机制，使用请自担风险。  
- 若无法识别按键可尝试：
  1. 以管理员身份运行 Python；
  2. 更换发送方式（修改源码切换到 `pyautogui`）；
  3. 使用虚拟键盘驱动（vJoy 等）。

---

## 🎶 扩展建议
- 支持其他乐器：吉他、贝斯、架子鼓、麦克风
- MIDI 文件解析 → `.lrcp`（已完成）
- 可视化键盘实时高lighter
- 录制实时演奏生成 `.lrcp`
- 智能节流 / 自适应多人限速策略

---

## 📌 示例演奏
- 运行 `play_piano.py` 选择 `twinkle_sample.lrcp`  
- 或在多人模式下运行 `play_piano_multi.py` 体验分散后的主旋律  

祝使用愉快！
